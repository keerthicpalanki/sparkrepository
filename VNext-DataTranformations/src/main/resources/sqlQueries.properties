# This file maintains SQL queries used in Spark SQL against In-Memory data stored in (Hive's) Columnar format.

# Select Queries
# Need to check on : PriceStartDate Vs StartDate and PriceEndDate Vs EndDate COLUMNs
queryOrderDim=select VMId,OrderId from OrderDim where StartDate <= EndDate
queryOrderApiPrices=select OrderId,DiscountType,PriceStartDate,PriceEndDate from OrdersAPIPrices

# Select Hive queries mainly to recreate tables - Naming convention : 'hiveQuery' + <table-name>
hiveQueryOrderAPIOrderIds=select distinct OrderId from OrdersAPIPrices

# Hive version, if needed, as INTERVAL is not supported.
#queryOrdersAPIPrices=SELECT * \
#  , ROW_NUMBER() OVER(PARTITION BY OrderId, MeterName ORDER BY Price_EndDate desc,Price_StartDate desc, OrderPriceRank asc) as RN \
#  , ROW_NUMBER() OVER(PARTITION BY OrderId, MeterName, Price_StartDate ORDER BY Price_EndDate desc, OrderPriceRank asc) as RN1 \
#  FROM ( \
#    SELECT * \
#  , TO_DATE(CAST(StartDate AS TIMESTAMP)) as Price_StartDate \
#  , from_unixtime(unix_timestamp(EndDate)+86399) as Price_EndDate \
#  FROM OrdersAPIPrices \
#  WHERE ((Case When EndDate='9999-01-01' then unix_timestamp(current_timestamp) else EndDate end) - StartDate) > 1 \
#  )
#-- where RN1 = 1

hiveQueryOrdersAPIPricesTmp=SELECT DISTINCT OAP.OrderId, OAP.MeterName, OAP.DiscountType, OAP.Price \
FROM Cosmos_Marketplace_UsageDaily as u INNER JOIN  \
OrdersAPIPrices as OAP  \
    ON u.OrderNumber = OAP.OrderId  \
    AND OAP.MeterName = u.ResourceID \
WHERE CAST(concat(u.usagedate,' 23:59:59') AS TIMESTAMP) BETWEEN OAP.PriceStartDate AND OAP.PriceEndDate

hiveQueryOrdersAPILatestPrices=SELECT * FROM ( \
		SELECT * \
			,	ROW_NUMBER() OVER(PARTITION BY OrderId, MeterName ORDER BY PriceEndDate desc,Price_StartDate desc, OrderPriceRank asc) RN  \
			,	ROW_NUMBER() OVER(PARTITION BY OrderId, MeterName, Price_StartDate ORDER BY PriceEndDate desc, OrderPriceRank asc) RN1 \
			FROM ( \
SELECT *, CAST(to_date(PriceStartDate) AS TIMESTAMP) AS Price_StartDate, CAST(CONCAT(to_date(PriceEndDate), ' 23:59:59') AS TIMESTAMP) AS Price_EndDate \
		FROM OrdersAPIPrices WHERE (CASE WHEN to_date(PriceEndDate) = '9999-01-01'  \
THEN unix_timestamp(from_unixtime(unix_timestamp())) ELSE unix_timestamp(PriceEndDate) END - unix_timestamp(PriceStartDate)) > 1 \
) AS T \
		  ) AS T1 \
	WHERE T1.RN1 = 1

hiveQueryVMUsage=SELECT \
		OrderId, \
			MeteredResourceGuid, \
			ResourceURI, \
			AzureRegion, \
			Project, \
			ServiceInfo1, \
			ServiceInfo2, \
			UsageDate, \
			NumberOfCores, \
			VMSize, \
			PartNumber, \
			Tags, \
			Properties, \
			SUM(Quantity) as Quantity, \
			SUM(Quantity) * NumberOfCores as CoreQuantity, \
			0 as IsCoreImage, \
			0 as IsMultiSolution, \
			1 as IsVMUsage, \
			cast(null as string) as TemplateUri, \
			cast(null as string) as CorrelationId, \
			cast(null as string) as MultiSolutionOfferName, \
			'UsageDaily' as UsageDataSource, \
			cast(null as string) as UsageAfterCancelDate, \
			cast(null as string) as VMUsageDefaultPrice, \
			cast(null as string) as InfluencedCost, \
			VMComputeStack, \
			cast(null as string) as Cluster, \
			unix_timestamp(current_timestamp) as AMDMCreatedDate, \
			cast(null as string) as AMDMCreatedBy, \
			unix_timestamp(current_timestamp) as AMDMUpdatedDate, \
			cast(null as string) as AMDMUpdatedBy, \
			OrderState, \
			IsMissing, \
            AdditionalInfo, \
            SubscriptionGuid, \
            publishername \
            FROM  \
		( \
SELECT \
                u.OrderNumber as OrderId, \
                u.resourceId as MeteredResourceGuid, \
                lower(u.ResourceURI) as ResourceURI, \
                u.sourceRegion as AzureRegion, \
                u.Project as Project, \
                u.ServiceInfo1 as ServiceInfo1, \
                u.ServiceInfo2 as ServiceInfo2, \
                u.UsageDate as UsageDate, \
                CASE \
                                                                WHEN lower(u.resourceId) = 'sharedcore' THEN 0.1666 \
                                                                WHEN lower(u.resourceId) LIKE '%core%' THEN regexp_replace(lower(u.resourceId), 'core', '') \
                                                                ELSE NULL \
                END as NumberOfCores, \
               CASE WHEN lower(AdditionalInfo) LIKE '%servicetype": "%' THEN \
 substring(substring(AdditionalInfo, instr(lower(AdditionalInfo), 'servicetype": "') + 15, 200), 0, \
		   instr(substring(AdditionalInfo, instr(lower(AdditionalInfo), 'servicetype": "') + 15, 200), '"') - 1 ) \
		   ELSE NULL END as VMSize, \
                u.PartNumber as PartNumber, \
                u.Tags as Tags, \
                u.Properties as Properties, \
                cast(u.totalUnits as float) as Quantity, \
                cast(u.totalUnits as float) * \
                CASE \
                                WHEN lower(u.resourceId) = 'sharedcore' THEN 0.1666 \
                                WHEN lower(u.resourceId) LIKE '%core%' THEN regexp_replace(lower(u.resourceId), 'core', '') \
                                ELSE NULL \
                END as CoreQuantity, \
                CASE \
                                WHEN lower(u.ResourceURI) LIKE '%microsoft.classiccompute%' THEN 'RDFE' \
                                WHEN lower(u.ResourceURI) LIKE '%microsoft.compute%' THEN 'CRP' \
                                ELSE 'Unknown' \
                END as VMComputeStack, \
                u.SubscriptionGuid as SubscriptionGuid, \
                CASE  \
                                WHEN OAP.OrderID IS NOT NULL THEN  \
                                ( \
                                                CASE \
                                                                WHEN lower(OAP.DiscountType) = 'none' AND cast(OAP.Price as DECIMAL) = 0.0 THEN 'Free' \
                                                                WHEN lower(OAP.DiscountType) = 'none' AND cast(OAP.Price as DECIMAL) > 0.0 THEN 'Paid' \
                                                                WHEN OAP.DiscountType IS NOT NULL THEN OAP.DiscountType \
                                                                WHEN OAPI.Orderid IS NULL THEN 'OrderAPI Missing Order' \
                                                                ELSE 'OrderAPI Missing Price' \
                                                END \
                                ) \
                                WHEN OAP1.OrderID IS NOT NULL THEN  \
                                ( \
                                                CASE \
                                                                WHEN lower(OAP1.DiscountType) = 'none' AND cast(OAP1.Price as DECIMAL) = 0.0 THEN 'Free' \
                                                                WHEN lower(OAP1.DiscountType) = 'none' AND cast(OAP1.Price as DECIMAL) > 0.0 THEN 'Paid' \
                                                                WHEN OAP1.DiscountType IS NOT NULL THEN OAP1.DiscountType \
                                                                WHEN OAPI.Orderid IS NULL THEN 'OrderAPI Missing Order' \
                                                                ELSE 'OrderAPI Missing Price' \
                                                END \
                                ) \
                                WHEN OAPI.Orderid IS NULL THEN 'OrderAPI Missing Order' \
                                ELSE 'OrderAPI Missing Price' \
                END as OrderState, \
		u.IsMissing, \
        u.AdditionalInfo, \
        OD.publishername \
        FROM  \
                Cosmos_Marketplace_UsageDaily as u \
LEFT JOIN Stg_ExceptionVMUsage_OrderNumberMappings as m \
                ON u.OrderNumber = m.OrderNumber \
LEFT JOIN OrderDim as OD \
                ON NVL(m.order_, u.OrderNumber) = OD.OrderId \
LEFT JOIN OrdersAPIPricesTmp as OAP \
                ON u.OrderNumber = OAP.OrderId  \
                AND OAP.MeterName = u.resourceId \
LEFT JOIN OrdersAPIPricesTmp as OAP1 \
                ON u.OrderNumber = OAP1.OrderId  \
                AND OAP1.MeterName = u.resourceId \
LEFT JOIN OrderAPIOrderIds as OAPI \
                ON u.OrderNumber = OAPI.OrderId  \
WHERE u.OrderNumber IS NOT NULL \
                AND u.PartNumber IS NOT NULL \
                 \
                AND CAST(concat(u.UsageDate, ' 23:59:59') AS TIMESTAMP) >= CAST('MAX_VM_USAGE_DATE' AS TIMESTAMP) \
                AND lower(u.resourceId) LIKE '%core%' \
		) as j \
		GROUP BY  \
			OrderId, \
			SubscriptionGuid, \
			MeteredResourceGuid, \
			ResourceURI, \
			AzureRegion, \
			Project, \
			ServiceInfo1, \
			ServiceInfo2, \
			UsageDate, \
			Properties, \
			PartNumber, \
			Tags, \
			VMComputeStack, \
			NumberOfCores, \
			VMSize, \
			OrderState, \
			IsMissing, \
            AdditionalInfo, \
            publishername


hiveQueryOrdersAPILatestPricesTmp=SELECT DISTINCT OAP.OrderId, OAP.MeterName, OAP.DiscountType, OAP.Price, OAP.Price_EndDate \
FROM VMUsage as t \
INNER JOIN OrdersAPILatestPrices as OAP \
    ON t.OrderId = OAP.OrderId \
	AND t.MeteredResourceGuid = OAP.MeterName \
WHERE CAST(concat(t.usagedate,' 23:59:59') AS TIMESTAMP) BETWEEN OAP.Price_StartDate AND OAP.Price_EndDate


queryStep1=SELECT \
	 OrderId \
	,MeteredResourceGUID \
	,ResourceURI \
    ,md5(ResourceURI) as ResourceURIHash \
	,AzureRegion \
	,Project \
	,ServiceInfo1 \
	,ServiceInfo2 \
	,NumberOfCores \
	,VMSize \
	,PartNumber \
	,NVL(Tags,'') as Tags \
	,Properties \
	,Quantity \
	,CoreQuantity \
	,IsCoreImage \
	,IsMultiSolution \
	,IsVMUsage \
	,TemplateUri \
	,CorrelationId \
	,MultiSolutionOfferName \
	,UsageDataSource \
	,UsageAfterCancelDate \
	,VMUsageDefaultPrice \
	,InfluencedCost \
	,VMComputeStack \
	,Cluster \
	,OrderState \
	,AdditionalInfo \
    ,SubscriptionGuid \
    ,publishername \
    ,'VMUsage' as UsageType \
    ,cast(null as string) as VMId \
    ,UsageDate \
    ,IsMissing \
    ,OrderId as Rowkey \
    FROM  \
  ( \
	SELECT \
		 t.OrderId \
		,MeteredResourceGUID \
		,ResourceURI \
		,AzureRegion \
		,Project \
		,ServiceInfo1 \
		,ServiceInfo2 \
		,UsageDate \
		,NumberOfCores \
		,VMSize \
		,PartNumber \
		,Tags \
		,Properties \
		,Quantity \
		,CoreQuantity \
		,IsCoreImage \
		,IsMultiSolution \
		,IsVMUsage \
		,TemplateUri \
		,CorrelationId \
		,MultiSolutionOfferName \
		,UsageDataSource \
		,UsageAfterCancelDate \
		,VMUsageDefaultPrice \
		,InfluencedCost \
		,VMComputeStack \
		,Cluster \
		,AMDMCreatedDate \
		,AMDMCreatedBy \
		,AMDMUpdatedDate \
		,AMDMUpdatedBy \
		, CASE WHEN lower(t.OrderState) = 'orderapi missing price' \
			 THEN  \
				( \
					CASE \
						WHEN lower(OALP.DiscountType) = 'none' AND cast(OALP.Price as DECIMAL) = 0.0 THEN 'Free' \
						WHEN lower(OALP.DiscountType) = 'none' AND cast(OALP.Price as DECIMAL) > 0.0 THEN 'Paid' \
						WHEN OALP.DiscountType IS NOT NULL THEN OALP.DiscountType \
						ELSE 'OrderAPI Missing Price' \
					END \
				)  \
		ELSE t.OrderState \
		END as OrderState \
		,ROW_NUMBER() Over(partition by t.OrderId, t.MeteredResourceGuid, t.UsageDate, t.ResourceURI, t.AzureRegion, t.PartNumber, t.AdditionalInfo, t.tags ORDER BY Price_EndDate desc) RN \
		,t.IsMissing \
        ,t.AdditionalInfo \
        ,t.SubscriptionGuid \
        ,t.publishername \
        FROM VMUsage as t \
	LEFT JOIN OrdersAPILatestPricesTmp as OALP \
	ON t.OrderId = OALP.OrderId  \
	AND t.MeteredResourceGuid = OALP.MeterName \
	 \
) as os \
Where RN = 1


hiveQueryMeteredUsage=SELECT \
		OrderId, \
			MeteredResourceGuid, \
			ResourceURI, \
			AzureRegion, \
			Project, \
			ServiceInfo1, \
			ServiceInfo2, \
			UsageDate, \
			NumberOfCores, \
			VMSize, \
			PartNumber, \
			Tags, \
			Properties, \
			SUM(Quantity) as Quantity, \
			SUM(Quantity) * NumberOfCores as CoreQuantity, \
			0 as IsCoreImage, \
			0 as IsMultiSolution, \
			0 as IsVMUsage, \
			cast(null as string) as TemplateUri, \
			cast(null as string) as CorrelationId, \
			cast(null as string) as MultiSolutionOfferName, \
			'UsageDaily' as UsageDataSource, \
			cast(null as string) as UsageAfterCancelDate, \
			cast(null as string) as VMUsageDefaultPrice, \
			cast(null as string) as InfluencedCost, \
			cast(null as string) as VMComputeStack, \
			cast(null as string) as Cluster, \
			unix_timestamp(current_timestamp) as AMDMCreatedDate, \
			cast(null as string) as AMDMCreatedBy, \
			unix_timestamp(current_timestamp) as AMDMUpdatedDate, \
			cast(null as string) as AMDMUpdatedBy, \
			OrderState, \
			IsMissing, \
            AdditionalInfo, \
            SubscriptionGuid, \
            publishername \
           FROM \
		( \
			SELECT \
				u.OrderNumber as OrderId, \
				u.resourceId as MeteredResourceGuid, \
				lower(u.ResourceURI) as ResourceURI, \
				u.sourceRegion as AzureRegion, \
				u.Project as Project, \
				u.ServiceInfo1 as ServiceInfo1, \
				u.ServiceInfo2 as ServiceInfo2, \
				u.UsageDate as UsageDate, \
				CASE \
						WHEN lower(u.ResourceID) = 'sharedcore' THEN 0.1666 \
						ELSE CASE \
								WHEN lower(u.ResourceID) = '16core' THEN 16.000 \
								WHEN lower(u.ResourceID) LIKE '%core%' THEN substring(u.ResourceID, 0, 1) \
								ELSE NULL \
							END \
				END as NumberOfCores, \
				CASE WHEN lower(AdditionalInfo) LIKE '%servicetype": "%' THEN regexp_replace(regexp_replace(SUBSTRING(lower(AdditionalInfo), \
instr(lower(AdditionalInfo), 'servicetype": "') + 15, 200), '}', ''), '"', '') \
ELSE NULL END as VMSize, \
				u.PartNumber as PartNumber, \
				u.Tags as Tags, \
				u.Properties as Properties, \
				cast(u.totalUnits as float) as Quantity, \
				cast(u.totalUnits as float) * \
				CASE \
						WHEN lower(u.ResourceID) = 'sharedcore' THEN 0.1666 \
						ELSE CASE \
								WHEN lower(u.ResourceID) = '16core' THEN 16.000 \
								WHEN lower(u.ResourceID) LIKE '%core%' THEN substring(u.ResourceID, 0, 1) \
								ELSE NULL \
							END \
				END as CoreQuantity, \
				u.SubscriptionGuid as SubscriptionGuid, \
				CASE \
					WHEN OAP.OrderID IS NOT NULL THEN  \
					( \
						CASE \
							WHEN lower(OAP.DiscountType) = 'none' AND cast(OAP.Price as DECIMAL) = 0.0 THEN 'Free' \
							WHEN lower(OAP.DiscountType) = 'none' AND cast(OAP.Price as DECIMAL) > 0.0 THEN 'Paid' \
							WHEN OAP.DiscountType IS NOT NULL THEN OAP.DiscountType \
							WHEN OAPI.Orderid IS NULL THEN 'OrderAPI Missing Order' \
							ELSE 'OrderAPI Missing Price' \
						END \
					) \
					WHEN OAP1.OrderID IS NOT NULL THEN  \
					( \
						CASE \
							WHEN lower(OAP1.DiscountType) = 'none' AND cast(OAP1.Price as DECIMAL) = 0.0 THEN 'Free' \
							WHEN lower(OAP1.DiscountType) = 'none' AND cast(OAP1.Price as DECIMAL) > 0.0 THEN 'Paid' \
							WHEN OAP1.DiscountType IS NOT NULL THEN OAP1.DiscountType \
							WHEN OAPI.Orderid IS NULL THEN 'OrderAPI Missing Order' \
							ELSE 'OrderAPI Missing Price' \
						END \
					) \
					WHEN OAPI.Orderid IS NULL THEN 'OrderAPI Missing Order' \
					ELSE 'OrderAPI Missing Price' \
				END as OrderState, \
				u.IsMissing, \
                u.AdditionalInfo, \
                OD.publishername \
                FROM \
				Cosmos_Marketplace_UsageDaily as u \
            LEFT JOIN OrderDim as OD \
                ON u.OrderNumber = OD.OrderId \
			LEFT JOIN OrdersAPIPrices as OAP \
				ON u.OrderNumber = OAP.OrderId  \
				AND OAP.MeterName = u.ResourceID \
			LEFT JOIN OrdersAPIPrices as OAP1 \
				ON u.OrderNumber = OAP1.OrderId  \
				AND OAP1.MeterName = u.ResourceID \
			LEFT JOIN OrderAPIOrderIds as OAPI \
				ON u.OrderNumber = OAPI.OrderId  \
			WHERE u.OrderNumber IS NOT NULL \
				AND lower(u.OrderNumber) <> 'order1' \
				AND u.PartNumber IS NOT NULL \
				 AND CAST(concat(u.UsageDate, ' 23:59:59') AS TIMESTAMP) >= CAST('MAX_3P_USAGE_DATE' AS TIMESTAMP) \
				 \
				AND lower(u.ResourceID) NOT LIKE '%core%'  \
		) as j \
		GROUP BY  \
			OrderId, \
			SubscriptionGuid, \
			MeteredResourceGuid, \
			ResourceURI, \
			AzureRegion, \
			Project, \
			ServiceInfo1, \
			ServiceInfo2, \
			UsageDate, \
			Properties, \
			PartNumber, \
			Tags, \
			NumberOfCores, \
			VMSize, \
			OrderState, \
			IsMissing, \
            AdditionalInfo, \
            publishername


queryStep2=SELECT \
	 OrderId \
	,MeteredResourceGUID \
	,ResourceURI \
    ,md5(ResourceURI) as ResourceURIHash \
	,AzureRegion \
	,Project \
	,ServiceInfo1 \
	,ServiceInfo2 \
	,NumberOfCores \
	,VMSize \
	,PartNumber \
	,NVL(Tags, '') as Tags \
	,Properties \
	,Quantity \
	,CoreQuantity \
	,IsCoreImage \
	,IsMultiSolution \
	,IsVMUsage \
	,TemplateUri \
	,CorrelationId \
	,MultiSolutionOfferName \
	,UsageDataSource \
	,UsageAfterCancelDate \
	,VMUsageDefaultPrice \
	,InfluencedCost \
	,VMComputeStack \
	,Cluster \
	,OrderState \
	,AdditionalInfo \
    ,SubscriptionGuid \
    ,publishername \
    ,'MeteredUsage' as UsageType \
    ,cast(null as string) as VMId \
    ,UsageDate \
    ,IsMissing \
    ,OrderId as Rowkey \
FROM  \
  ( \
	SELECT \
		 t.OrderId \
		,MeteredResourceGUID \
		,ResourceURI \
		,AzureRegion \
		,Project \
		,ServiceInfo1 \
		,ServiceInfo2 \
		,UsageDate \
		,NumberOfCores \
		,VMSize \
		,PartNumber \
		,Tags \
		,Properties \
		,Quantity \
		,CoreQuantity \
		,IsCoreImage \
		,IsMultiSolution \
		,IsVMUsage \
		,TemplateUri \
		,CorrelationId \
		,MultiSolutionOfferName \
		,UsageDataSource \
		,UsageAfterCancelDate \
		,VMUsageDefaultPrice \
		,InfluencedCost \
		,VMComputeStack \
		,Cluster \
		,AMDMCreatedDate \
		,AMDMCreatedBy \
		,AMDMUpdatedDate \
		,AMDMUpdatedBy \
		, CASE WHEN lower(t.OrderState) = 'orderapi missing price'  \
			 THEN  \
				( \
					CASE \
						WHEN lower(OALP.DiscountType) = 'none' AND cast(OALP.Price as DECIMAL) = 0.0 THEN 'Free' \
						WHEN lower(OALP.DiscountType) = 'none' AND cast(OALP.Price as DECIMAL) > 0.0 THEN 'Paid' \
						WHEN OALP.DiscountType IS NOT NULL THEN OALP.DiscountType \
						ELSE 'OrderAPI Missing Price' \
					END \
				)  \
		ELSE t.OrderState \
		END as OrderState \
		,ROW_NUMBER() Over(partition by t.OrderId, t.MeteredResourceGuid, t.UsageDate, t.ResourceURI, t.AzureRegion, t.PartNumber, t.AdditionalInfo, t.tags ORDER BY Price_EndDate desc) RN, \
		t.IsMissing \
        ,t.AdditionalInfo \
        ,t.SubscriptionGuid \
        ,t.publishername \
        FROM MeteredUsage t \
	LEFT JOIN OrdersAPILatestPricesTmp  OALP \
			ON t.OrderId = OALP.OrderId  \
				AND t.MeteredResourceGuid = OALP.MeterName \
				 \
		) DERT \
		Where RN = 1

hiveQueryOrderAPIPricesBCP=SELECT DISTINCT OAP.OrderId, OAP.MeterName, OAP.DiscountType, OAP.Price FROM OrdersAPIPrices OAP \
INNER JOIN ( \
SELECT DISTINCT `TimeStamp`, CASE WHEN VPCount = 0 THEN NULL ELSE concat(string(VPCount), 'core') END as MeterName \
FROM Cosmos_Marketplace_Core_ComputeUsage_BCP \
)  ud \
ON OAP.MeterName = ud.MeterName \
WHERE to_date(from_unixtime(UNIX_TIMESTAMP(ud.`TimeStamp`, 'MM/dd/yyyy'), 'yyyy-MM-dd')) BETWEEN OAP.PriceStartDate AND OAP.PriceEndDate

queryStep3CoreOrder=SELECT \
	cast(null as string) as OrderId, \
	cast(null as string) as MeteredResourceGUID, \
	cast(null as string) as ResourceURI, \
    cast(null as string) as ResourceURIHash, \
	ud.location as AzureRegion, \
	cast(null as string) as Project, \
	cast(null as string) as ServiceInfo1, \
	cast(null as string) as ServiceInfo2, \
	ud.VPCount as NumberOfCores, \
	ud.Size as VMSize, \
	ud.PartNumber as PartNumber, \
	cast('' as string) as Tags, \
	cast(null as string) as Properties, \
	cast(ud.QuantityVMs as float) * 24 as Quantity, \
	cast(ud.UsageHours as float) as CoreQuantity, \
	1 as IsCoreImage, \
	0 as IsMultiSolution, \
	1 as IsVMUsage, \
	cast(null as string) as TemplateUri, \
	cast(null as string) as CorrelationId, \
	cast(null as string) as MultiSolutionOfferName, \
	ud.DataSource as UsageDataSource, \
	cast(null as string) as UsageAfterCancelDate, \
	cast(null as string) as VMUsageDefaultPrice, \
	cast(null as string) as InfluencedCost, \
	'CORE' as VMComputeStack, \
	ud.Cluster as Cluster, \
	'Unknown' as OrderState, \
    cast(null as string) as AdditionalInfo, \
    ud.subscriptionid as SubscriptionGuid, \
    ud.publishername, \
    'CoreOrders' as UsageType, \
    ud.VMId, \
    cast(to_date(from_unixtime(UNIX_TIMESTAMP(ud.`TimeStamp`, 'MM/dd/yyyy'), 'yyyy-MM-dd')) as string) as UsageDate, \
    0 as IsMissing, \
    ud.VMId as Rowkey \
FROM CoreUsage_Stg as ud


# Join Query to be used to create the table Cosmos_UsageDaily_MultiSolution
hiveQueryCosmos_UsageDaily_MultiSolution=SELECT u.* FROM Cosmos_Marketplace_UsageDaily u JOIN MultiSolutionTemplate m ON lower(u.resourceuri) = lower(m.resourceUri1)

# <TODO> Take care of amdm.udfGenerateResourceUriHash(ResourceUrilower)
hiveQueryCosmos_UsageDaily_MultiSolution_Compute_DIM=SELECT \
			u.ordernumber, \
			u.MeteredResourceGuid, \
			u.ResourceURI, \
			u.ResourceUriHash, \
			u.Location, \
			u.Project, \
			u.ServiceInfo1, \
			u.ServiceInfo2, \
			u.UsageDate, \
			u.PartNumber, \
			u.Tags, \
			u.additionalinfo, \
			u.totalUnits, \
			u.SubscriptionGuid, \
			u.isMissing, \
			CASE \
				WHEN lower(additionalinfo) LIKE '%servicetype":"%' THEN substring(substring(additionalinfo, instr(additionalinfo, '%ServiceType":"%') + 14, 200), 0, instr(substring(additionalinfo, instr(additionalinfo, '%ServiceType":"%') + 14, 200), '%"%') - 1 ) \
				ELSE NULL \
			END as VMSize, \
            Properties \
		FROM \
		( \
			SELECT \
				ordernumber, \
				resourceId as MeteredResourceGuid, \
				sourceRegion as Location, \
				Project, \
				ServiceInfo1, \
				ServiceInfo2, \
				UsageDate, \
				PartNumber, \
				Tags, \
				additionalinfo, \
				totalUnits, \
				lower(ResourceURI) as ResourceURI, \
				ResourceUri as ResourceUriHash, \
				SubscriptionGuid, \
				isMissing, \
                Properties \
			FROM Cosmos_UsageDaily_MultiSolution \
		) as u \
		LEFT JOIN \
		( \
			SELECT DISTINCT OrderNumber AS OrderId, UsageDate, totalUnits, \
			lower(ResourceUri) as ResourceUri, \
			upper(ResourceUri) AS ResourceUriHash \
			FROM Cosmos_UsageDaily_MultiSolution \
			WHERE lower(additionalinfo) NOT LIKE '%datatr%' \
			AND OrderNumber IS NOT NULL \
		) as m \
		ON u.ResourceUri  = m.ResourceUri \
		AND u.UsageDate = m.UsageDate \
		AND u.totalUnits = m.totalUnits \
		WHERE lower(additionalinfo) NOT LIKE '%datatr%' \
		AND m.ResourceUri IS NULL \
		AND u.UsageDate >= TO_DATE(CAST('MAX_MS_USAGE_DATE' AS DATE))


queryStep4OrderUsageFact=SELECT \
		OrderId, \
		MeteredResourceGuid, \
		ResourceURI, \
        md5(ResourceURI) as ResourceURIHash, \
		AzureRegion, \
		Project, \
		ServiceInfo1, \
		ServiceInfo2, \
		NumberOfCores, \
		VMSize, \
		PartNumber, \
		NVL(Tags, '') as Tags, \
		Properties, \
		SUM(Quantity) as Quantity, \
		SUM(Quantity) * NumberOfCores as CoreQuantity, \
		0 as IsCoreImage, \
		1 as IsMultiSolution, \
		1 as IsVMUsage, \
		cast(null as string) as TemplateUri, \
		cast(null as string) as CorrelationId, \
		cast(null as string) as MultiSolutionOfferName, \
		'UsageDaily MultiSolution' as UsageDataSource, \
		cast(null as string) as UsageAfterCancelDate, \
		cast(null as string) as VMUsageDefaultPrice, \
		cast(null as string) as InfluencedCost, \
		VMComputeStack, \
		cast(null as string) as Cluster, \
		OrderState, \
		additionalinfo, \
        SubscriptionGuid, \
        publishername, \
        'MultiSolution' as UsageType, \
        cast(null as string) as VMId, \
        UsageDate, \
        isMissing, \
        md5(ResourceURI) as Rowkey \
        FROM \
		( \
			SELECT DISTINCT \
				u.OrderNumber as OrderId, \
				u.MeteredResourceGuid as MeteredResourceGuid, \
				u.ResourceURI as ResourceURI, \
				u.Location as AzureRegion, \
				u.Project as Project, \
				u.ServiceInfo1 as ServiceInfo1, \
				u.ServiceInfo2 as ServiceInfo2, \
				u.UsageDate as UsageDate, \
				apc.Cores as NumberOfCores, \
				u.VMSize as VMSize, \
				u.PartNumber as PartNumber, \
				u.Tags as Tags, \
				u.additionalinfo as additionalinfo, \
				cast(u.totalUnits as float) as Quantity, \
				cast(u.totalUnits as float) * COALESCE(apc.Cores, 1) as CoreQuantity, \
				CASE \
					WHEN lower(u.ResourceURI) LIKE '%microsoft.classiccompute%' THEN 'RDFE' \
					WHEN lower(u.ResourceURI) LIKE '%microsoft.compute%' THEN 'CRP' \
					ELSE 'Unknown' \
				END as VMComputeStack, \
				u.SubscriptionGuid as SubscriptionGuid, \
				u.isMissing as isMissing, \
				CASE WHEN lower(u.additionalinfo) LIKE '%compute%sw%' THEN 'Paid' ELSE 'Free' END as OrderState, \
                u.Properties, \
                OD.publishername \
			FROM Cosmos_UsageDaily_MultiSolution_Compute_DIM u \
			INNER JOIN OrderDim as OD \
				ON OD.OrderId = u.OrderNumber \
			LEFT JOIN \
			( \
				SELECT DISTINCT \
					CONCAT(Tier, '_', NameLocKey) AS VMSize, \
					cast(Cores as Int) as Cores, \
					CASE WHEN Cores IS NOT NULL THEN concat(string(Cores), 'CORE') ELSE NULL END as MeterName \
				FROM stg_azurepricingcalculator \
				UNION \
				SELECT DISTINCT \
					VMSize, \
					cast(Cores as Int) as Cores, \
					CASE WHEN Cores IS NOT NULL THEN concat(string(Cores), 'CORE') ELSE NULL END as MeterName \
				FROM stg_missingazurepricing \
			) as apc \
			ON apc.VMSize = u.VMSize \
			WHERE u.UsageDate >= TO_DATE(CAST('MAX_MS_USAGE_DATE' AS DATE)) \
		) as DER_TBL \
		GROUP BY \
			SubscriptionGuid, \
			MeteredResourceGuid, \
			ResourceURI, \
			OrderId, \
			AzureRegion, \
			Project, \
			ServiceInfo1, \
			ServiceInfo2, \
			UsageDate, \
			NumberOfCores, \
			VMSize, \
			PartNumber, \
			NVL(Tags, ''), \
			additionalinfo, \
			VMComputeStack, \
			OrderState, \
			isMissing, \
            Properties, \
            publishername

hiveQueryVMSizes=SELECT \
VMId, \
ResourceURI, \
MeteredResourceGUID, \
NumberOfCores, \
VMSize, \
UsageDate, \
OperatingSystemName, \
OperatingSystemFamily, \
AM_OperatingSystemFamily, \
Rowkey \
FROM \
( \
SELECT \
u.VMId, \
u.ResourceURI, \
u.MeteredResourceGUID, \
u.NumberOfCores, \
u.VMSize, \
u.UsageDate, \
OD.OperatingSystemName, \
OD.OperatingSystemFamily, \
regexp_replace(lower(OD.OperatingSystemFamily), 'iaas - ', '') AS AM_OperatingSystemFamily, \
ROW_NUMBER() OVER (PARTITION BY u.VMId, u.ResourceURI, u.MeteredResourceGUID, u.NumberOfCores ORDER BY u.UsageDate ASC) as VMSizeRank, \
u.Rowkey \
FROM OrderUsageFact_Temp1 u \
LEFT JOIN OrderDIM o \
ON u.Rowkey = o.Rowkey \
LEFT JOIN OfferDIM OD \
ON o.OfferRowKey = OD.rowkey \
WHERE u.VMSize IS NOT NULL \
AND u.Quantity <> 0 \
GROUP BY u.VMId, \
u.ResourceURI, \
u.MeteredResourceGUID, \
u.NumberOfCores, \
u.VMSize, \
u.UsageDate, \
OD.OperatingSystemName, \
OD.OperatingSystemFamily, \
u.Rowkey \
) t \
WHERE VMSizeRank = 1

hiveQueryPrices=SELECT DISTINCT * \
FROM \
( \
SELECT \
CASE \
WHEN lower(CONCAT(Tier, '_', NameLocKey)) LIKE '%v2%' THEN regexp_replace(lower(CONCAT(Tier, '_', NameLocKey)), 'v2', '_v2') \
ELSE CONCAT(Tier, '_', NameLocKey) \
END AS VMSize, \
VMType, \
Series, \
Cores, \
Tier, \
Prices_Default \
FROM stg_AzurePricingCalculator \
UNION \
SELECT \
VMSize, \
VMType, \
Series, \
cast(Cores as string) as Cores, \
Tier, \
cast(Prices_Default as string) as Prices_Default \
FROM stg_MissingAzurepricing \
) a

query3rdPartyMultiSol=SELECT \
mvu.OrderId, \
mvu.MeteredResourceGUID, \
mvu.SubscriptionGuid, \
mvu.ResourceURI, \
mvu.ResourceURIHash, \
mvu.AzureRegion, \
mvu.Project, \
mvu.ServiceInfo1, \
mvu.ServiceInfo2, \
mvu.NumberOfCores, \
mvu.VMSize, \
mvu.PartNumber, \
mvu.Tags, \
mvu.Properties, \
mvu.Quantity, \
mvu.CoreQuantity, \
mvu.IsCoreImage, \
CASE WHEN ms.OrderId IS NULL THEN mvu.IsMultiSolution ELSE 1 END as IsMultiSolution, \
mvu.IsVMUsage, \
mvu.TemplateUri, \
mvu.CorrelationId, \
mvu.MultiSolutionOfferName, \
CASE WHEN ms.OrderId IS NULL THEN mvu.UsageDataSource ELSE 'UsageDaily MultiSolution' END as UsageDataSource, \
mvu.UsageAfterCancelDate, \
mvu.VMUsageDefaultPrice, \
mvu.InfluencedCost, \
mvu.VMComputeStack, \
mvu.Cluster, \
CASE WHEN ms.OrderId IS NULL THEN mvu.OrderState ELSE CASE WHEN lower(mvu.additionalinfo) LIKE '%compute%sw%' THEN 'Paid' ELSE 'Free' END END as OrderState, \
mvu.AdditionalInfo, \
mvu.publishername, \
mvu.UsageType, \
mvu.VMId, \
mvu.UsageDate, \
mvu.IsMissing, \
mvu.Rowkey \
FROM OrderUsageFact_Temp1 as mvu \
LEFT JOIN OrderDIM as ms \
ON lower(mvu.ResourceUriHash) = lower(ms.ResourceUriHash)

hiveQueryRankedUsageLocation=WITH GovCloudUsage AS ( \
SELECT DISTINCT \
OrderId \
FROM OrderUsageFact_Stg \
WHERE lower(AzureRegion) LIKE '%gov%' \
) \
SELECT \
a.OrderId, \
a.AzureRegion, \
CASE \
WHEN b.OrderId IS NULL THEN 0 \
ELSE 1 \
END as HasUsedGovCloud, \
ROW_NUMBER() OVER (PARTITION BY a.OrderId ORDER BY a.UsageDate DESC)  as LocationRank \
FROM OrderUsageFact_Stg a \
LEFT JOIN GovCloudUsage b \
ON a.OrderId = b.OrderId \
WHERE a.AzureRegion IS NOT NULL

queryOrderUsageFact=SELECT DISTINCT \
OUF.OrderId, \
OUF.MeteredResourceGUID, \
OD.azuresubscriptionid as SubscriptionGuid, \
OUF.ResourceURI, \
OUF.ResourceURIHash, \
OUF.AzureRegion, \
OUF.Project, \
OUF.ServiceInfo1, \
OUF.ServiceInfo2, \
OUF.NumberOfCores, \
CASE \
WHEN OUF.VMSize IS NULL THEN sizes.VMSize \
ELSE OUF.VMSize \
END as VMSize, \
OUF.PartNumber, \
OUF.Tags, \
OUF.Properties, \
OUF.Quantity, \
OUF.CoreQuantity, \
OUF.IsCoreImage, \
OUF.IsMultiSolution, \
OUF.IsVMUsage, \
OUF.TemplateUri, \
OUF.CorrelationId, \
OUF.MultiSolutionOfferName, \
OUF.UsageDataSource, \
CASE \
WHEN to_date(from_unixtime(cast(OD.canceldate/1000 as bigint))) = '1900-01-01' THEN 0 \
WHEN to_date(OUF.UsageDate) > to_date(from_unixtime(cast(OD.canceldate/1000 as bigint))) THEN 1 \
ELSE 0 \
END as UsageAfterCancelDate, \
CASE \
WHEN lower(sizes.OperatingSystemName) LIKE '%windows[_]oracle%' THEN oracle_prices.Prices_Default \
ELSE prices.Prices_Default \
END as VMUsageDefaultPrice, \
OUF.Quantity * \
CASE WHEN lower(sizes.OperatingSystemName) LIKE '%windows[_]oracle%' THEN oracle_prices.Prices_Default ELSE prices.Prices_Default END as InfluencedCost, \
OUF.VMComputeStack, \
OUF.Cluster, \
OUF.OrderState, \
OUF.AdditionalInfo, \
OUF.publishername, \
OUF.UsageType, \
OD.VMId, \
OUF.UsageDate, \
OUF.IsMissing, \
OUF.Rowkey \
FROM OrderUsageFact_Stg as OUF \
LEFT JOIN OrderDim OD \
ON OUF.Rowkey = OD.Rowkey \
LEFT JOIN VMSizes as sizes \
ON OUF.Rowkey = sizes.Rowkey \
AND NVL(lower(OUF.ResourceURI), '') = NVL(lower(sizes.ResourceURI), '') \
AND NVL(lower(OUF.MeteredResourceGUID), '') = NVL(lower(sizes.MeteredResourceGUID), '') \
LEFT JOIN Prices as prices \
ON NVL(lower(sizes.OperatingSystemName),'linux') NOT LIKE '%windows[_]oracle%' \
AND NVL(OUF.VMSize, regexp_replace(sizes.VMSize, ',', '')) = prices.VMSize \
AND NVL(sizes.AM_OperatingSystemFamily,'linux') = prices.VMType \
 \
LEFT JOIN Prices as oracle_prices \
ON lower(sizes.OperatingSystemName) LIKE '%windows[_]oracle%' \
AND SUBSTRING(NVL(OUF.VMSize, sizes.VMSize), INSTR(NVL(OUF.VMSize, sizes.VMSize), '%[_]%') + 1, 1) = oracle_prices.Series \
AND sizes.NumberOfCores = oracle_prices.Cores \
AND \
CASE \
WHEN lower(sizes.OperatingSystemName) LIKE 'windows[_]oracle[_]12c[_]db%[_]ent' THEN 'Database Enterprise' \
WHEN lower(sizes.OperatingSystemName) LIKE 'windows[_]oracle[_]12c[_]db%[_]std' THEN 'Database Standard' \
WHEN lower(sizes.OperatingSystemName) = 'windows_oracle_12c_wls_ent' THEN 'Weblogic Server Enterprise' \
WHEN lower(sizes.OperatingSystemName) = 'windows_oracle_12c_wls_std' THEN 'Weblogic Server Standard' \
ELSE 'Error' \
END = oracle_prices.Tier \
AND lower(oracle_prices.VMType) = 'oracle'

createUsageFactIfNotExists=CREATE TABLE IF NOT EXISTS OrderUsageFact ( \
OrderId string, \
MeteredResourceGUID string, \
SubscriptionGUID string, \
ResourceURI string, \
ResourceURIHash int, \
AzureRegion string, \
Project string, \
ServiceInfo1 string, \
ServiceInfo2 string, \
NumberOfCores FLOAT, \
VMSize string, \
PartNumber string, \
Tags string, \
Properties string, \
Quantity FLOAT, \
CoreQuantity FLOAT, \
IsCoreImage Boolean, \
IsMultiSolution Boolean, \
IsVMUsage Boolean, \
TemplateUri string, \
CorrelationId string, \
MultiSolutionOfferName string, \
UsageDataSource string, \
UsageAfterCancelDate boolean, \
VMUsageDefaultPrice FLOAT, \
InfluencedCost Boolean, \
VMComputeStack string, \
Cluster string, \
OrderState string, \
additionalInfo string, \
PublisherName string, \
UsageType string, \
VMID string, \
DataLineageID string) partitioned by (UsageDate DATE,ismissing int) \
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe' WITH SERDEPROPERTIES ("case.insensitive" = "true", "ignore.malformed.json" = "true") \
STORED AS TEXTFILE LOCATION \
'wasb://orderusagefact@azuredevopsdevdatatank.blob.core.windows.net/'

hiveQueryCoreUsage_Stg=WITH VMMetaData AS ( \
SELECT DISTINCT \
VMId \
,BillingContext \
,SourceImageName \
,SourceImageType \
,CRPOffer \
,CRPSku \
,CRPPublisher \
,AM_MappedPublisher \
,CASE \
WHEN lower(BillingContext) LIKE '%linux%' THEN 'Linux' \
WHEN lower(BillingContext) LIKE '%window%' THEN 'Windows' \
END as AM_OsType \
,ROW_NUMBER() OVER(PARTITION BY VMId ORDER BY SourceImageName DESC) as VMRank \
FROM Cosmos_Marketplace_Core_ComputeUsage_BCP u \
), \
LatestVMRecord AS ( \
SELECT `Timestamp` \
,VMId \
,DeploymentId \
,`Location` \
,DataCenter \
,Cluster \
,Cloud \
,VPCount \
,Os \
,OsType \
,Size \
,SizeFamily \
,SwType \
,IsCrp \
,IsMarketplace \
,`Role` \
,RoleInstance \
,Extensions \
,SubscriptionId \
,Parsed_SubId \
,DeploymentType \
,DeploymentStatus \
,DeploymentRdfeOsFamily \
,DeploymentLabel \
,DeploymentName \
,IsTrial \
,IsTrialIncluded \
,IsPaidIncluded \
,UsageType \
,UsageResourceKind \
,CRPVMId \
,CRPSubscriptionId \
,ResourceGroupName \
,VMSize \
,PartNumber \
,OrderNumber \
,CRPOffer \
,CRPPublisher \
,CRPSku \
,CRPVersion \
,ComputeSource \
,DataSource \
,QuantityVMs \
,UsageHours \
,AM_MappedPublisher \
,AM_SearchMethod \
,AM_DataSource \
,ROW_NUMBER() OVER(PARTITION BY VMId ORDER BY from_unixtime(UNIX_TIMESTAMP(`Timestamp`, 'MM/dd/yyyy HH:mm:ss'), 'yyyy-MM-dd hh:mm:ss') DESC) as VMRank \
FROM Cosmos_Marketplace_Core_ComputeUsage_BCP \
), \
VMDeploymentCreatedTime AS ( \
SELECT \
VMId \
,MIN(from_unixtime(UNIX_TIMESTAMP(`Timestamp`, 'MM/dd/yyyy HH:mm:ss'), 'yyyy-MM-dd hh:mm:ss')) AS DeploymentCreatedTime \
FROM Cosmos_Marketplace_Core_ComputeUsage_BCP \
GROUP BY VMId \
), \
HasVMIdUsedGovCloud AS ( \
SELECT DISTINCT VMId \
FROM Cosmos_Marketplace_Core_ComputeUsage_BCP \
WHERE lower(Cloud) = 'usgov' \
OR lower(Location) LIKE '%gov%' \
) \
SELECT \
u.`Timestamp` \
,u.VMId \
,u.DeploymentId \
,u.Location \
,u.DataCenter \
,u.Cluster \
,u.Cloud \
,u.VPCount \
,u.Os \
,u.OsType \
,u.Size \
,u.SizeFamily \
,u.SwType \
,u.IsCrp \
,u.IsMarketplace \
,u.Role \
,u.RoleInstance \
,u.Extensions \
,u.SubscriptionId \
,u.Parsed_SubId \
,u.DeploymentType \
,u.DeploymentStatus \
,u.DeploymentRdfeOsFamily \
,u.DeploymentLabel \
,u.DeploymentName \
,u.IsTrial \
,u.IsTrialIncluded \
,u.IsPaidIncluded \
,u.UsageType \
,u.UsageResourceKind \
,u.CRPVMId \
,u.CRPSubscriptionId \
,u.ResourceGroupName \
,u.VMSize \
,u.PartNumber \
,u.OrderNumber \
,md.CRPOffer \
,md.CRPPublisher \
,md.CRPSku \
,u.CRPVersion \
,u.ComputeSource \
,u.QuantityVMs \
,u.UsageHours \
,u.AM_SearchMethod \
,u.AM_DataSource \
,NVL(CASE WHEN lower(u.AM_MappedPublisher) = 'bitnami' THEN \
SUBSTRING(u.AM_DataSource, 0, length(u.AM_DataSource)-3) \
+ CASE WHEN lower(md.SourceImageType) = 'bitnami' THEN 'Original' \
WHEN NVL(md.SourceImageType,'') = '' AND NVL(md.SourceImageName,'') = '' THEN 'VMDepot' \
WHEN NVL(lower(md.SourceImageType),'') = 'user' THEN 'USER' \
END \
ELSE \
u.AM_DataSource \
+ CASE WHEN lower(u.AM_MappedPublisher) IN ('oracle on windows', 'oracle linux') THEN \
CASE WHEN NVL(lower(md.SourceImageType),'') NOT IN ('oracle on windows', 'oracle linux') THEN ':New' ELSE ':Pre' END \
ELSE '' \
END \
END, 'ComputeUsageExtendedDailyV4:CRP:Bitnami:VMDepot') as DataSource \
,m.DeploymentCreatedTime \
,COALESCE( \
CASE WHEN \
CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END ='' THEN NULL \
ELSE CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END END, \
CASE WHEN md.CRPSku = '' THEN NULL ELSE md.CRPSku END \
,md.BillingContext,'') + CASE WHEN lower(md.SourceImageType) = 'user' THEN ' USER' ELSE '' END as SKU \
,md.BillingContext \
,md.AM_MappedPublisher \
,md.AM_OsType \
,CASE WHEN g.VMId IS NULL THEN 0 ELSE 1 END as HasUsedGovCloud \
,	concat(u.AM_MappedPublisher , '-' , md.BillingContext) AS OfferName \
,	CONCAT(u.AM_MappedPublisher , ':' , md.BillingContext , ':' , COALESCE( \
CASE WHEN \
CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END ='' THEN NULL \
ELSE CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END END, \
CASE WHEN md.CRPSku = '' THEN NULL ELSE md.CRPSku END \
,md.BillingContext,'') + CASE WHEN lower(md.SourceImageType) = 'user' THEN ' USER' ELSE '' END) AS ServicePlanKey \
,	concat(u.AM_MappedPublisher , '-' , regexp_replace(md.BillingContext,'_',' ') , '-' , regexp_replace(COALESCE( \
CASE WHEN \
CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END ='' THEN NULL \
ELSE CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END END, \
CASE WHEN md.CRPSku = '' THEN NULL ELSE md.CRPSku END \
,md.BillingContext,'') + CASE WHEN lower(md.SourceImageType) = 'user' THEN ' USER' ELSE '' END,'_',' ')) AS ServicePlanName \
,	concat(u.AM_MappedPublisher , '-' , regexp_replace(COALESCE( \
CASE WHEN \
CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END ='' THEN NULL \
ELSE CASE WHEN md.SourceImageName LIKE '%__%' \
THEN SUBSTRING(md.SourceImageName, INSTR(md.SourceImageName, '%__%')+2, 200) \
ELSE md.SourceImageName END END, \
CASE WHEN md.CRPSku = '' THEN NULL ELSE md.CRPSku END \
,md.BillingContext,'') + CASE WHEN lower(md.SourceImageType) = 'user' THEN ' USER' ELSE '' END,'_',' ')) AS ServicePlanTitle \
,	CONCAT(u.VMId, ':' , md.BillingContext) AS OrderKey \
,	CONCAT(u.AM_MappedPublisher , '-' , regexp_replace(md.BillingContext,'_',' ')) AS OfferTitle \
,	CASE WHEN lower(u.Cloud) = 'usgov' OR lower(u.Location) LIKE '%gov%' THEN 1 ELSE 0 END AS IsFairFax \
,p.PublisherNaturalIdentifier as PublisherName \
FROM LatestVMRecord u \
LEFT JOIN VMMetaData md \
ON u.VMId = md.VMId \
LEFT JOIN VMDeploymentCreatedTime m \
ON u.VMId = m.VMId \
LEFT JOIN HasVMIdUsedGovCloud  g \
ON u.VMId = g.VMId \
LEFT JOIN ( \
SELECT \
'Barracuda' AS CorePublisherName \
,	'barracudanetworks' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'Riverbed' AS CorePublisherName \
,'riverbed' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'Oracle' AS CorePublisherName \
,'msopentech' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'Bitnami' AS CorePublisherName \
,'Bitnami' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'Zulu' AS CorePublisherName \
,'azul' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'CoreOS' AS CorePublisherName \
,'CoreOS' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'Github-Enterprise' AS CorePublisherName \
,'github-enterprise' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'Puppet' AS CorePublisherName \
,'puppet' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'USER' AS CorePublisherName \
,'user' AS PublisherNaturalIdentifier \
UNION \
SELECT \
'RedHat' AS CorePublisherName \
,'RedHat' as PublisherNaturalIdentifier \
) p \
ON lower(p.CorePublisherName) = CASE \
WHEN lower(u.AM_MappedPublisher) LIKE '%barracuda%' THEN 'Barracuda' \
WHEN lower(u.AM_MappedPublisher) = 'coreos' THEN 'CoreOS' \
WHEN lower(u.AM_MappedPublisher) = 'riverbed steelhead' THEN 'Riverbed' \
WHEN lower(u.AM_MappedPublisher) = 'zulu' THEN 'Zulu' \
WHEN lower(u.AM_MappedPublisher) LIKE 'oracle%' THEN 'Oracle' \
WHEN lower(u.AM_MappedPublisher) = 'bitnami' THEN 'Bitnami' \
WHEN lower(u.AM_MappedPublisher) = 'redhat' THEN 'RedHat' \
WHEN lower(u.AM_MappedPublisher) = 'puppet enterprise' THEN 'Puppet' \
WHEN lower(u.AM_MappedPublisher) = 'github-enterprise' THEN 'Github-Enterprise' \
WHEN lower(u.AM_MappedPublisher) = 'user' THEN 'USER' \
ELSE 'ERROR' \
END \
WHERE u.VMId <> '' \
AND u.VMRank = 1 \
AND md.VMRank = 1


# Select Queries
hiveQueryDailyExceptionVMUsage_OrderNumberMappings=Select OrderNumber as OrderId,SubscriptionId, Order_ as Actual_OrderNumber from Stg_ExceptionVMUsage_OrderNumberMappings
hiveQueryCosmos_marketplace_usagedaily=select RecordsCount,SubscriptionGuid,resourceId,sourceRegion,usageDate,resourceUri,tags,PAVersion,totalUnits,ts,resourceSubType,resourceType,orderNumber ,partNumber,properties,additionalInfo,infoFields,project,ServiceInfo2,ServiceInfo1 from cosmos_marketplace_usagedaily

#Select Queries
hiveQuerySellerinsightsOrders = select * from OrderDim
SellerinsightsOrders = select * from OrderDim